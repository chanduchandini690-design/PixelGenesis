# backend_demo_secure.py
from flask import Flask, request, jsonify
from flask_cors import CORS
import hashlib, secrets, json, uuid
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import rsa, padding
from cryptography.fernet import Fernet

app = Flask(_name_)
CORS(app)

# ----------------- Setup -----------------
# RSA keypair for signing credentials
PRIVATE_KEY = rsa.generate_private_key(public_exponent=65537, key_size=2048)
PUBLIC_KEY = PRIVATE_KEY.public_key()
PUBKEY_PEM = PUBLIC_KEY.public_bytes(
    serialization.Encoding.PEM, serialization.PublicFormat.SubjectPublicKeyInfo
)
PUBKEY_FINGERPRINT = hashlib.sha256(PUBKEY_PEM).hexdigest()

# Symmetric key for encrypting credentials
FERNET_KEY = Fernet.generate_key()
FERNET = Fernet(FERNET_KEY)

# In-memory store
credential_vault = {}
API_KEY = secrets.token_urlsafe(16)  # print this to frontend

print("API_KEY (use this in x-api-key header):", API_KEY)

# ----------------- Helpers -----------------
def sign_data(data_bytes):
    return PRIVATE_KEY.sign(
        data_bytes,
        padding.PSS(mgf=padding.MGF1(hashes.SHA256()), salt_length=padding.PSS.MAX_LENGTH),
        hashes.SHA256()
    )

def verify_signature(data_bytes, signature):
    try:
        PUBLIC_KEY.verify(signature, data_bytes,
                          padding.PSS(mgf=padding.MGF1(hashes.SHA256()), salt_length=padding.PSS.MAX_LENGTH),
                          hashes.SHA256())
        return True
    except:
        return False

# ----------------- Routes -----------------
@app.route("/issue", methods=["POST"])
def issue():
    key = request.headers.get("x-api-key")
    if key != API_KEY:
        return jsonify({"error":"invalid_api_key"}), 401

    body = request.get_json()
    user = body.get("user")
    cid = body.get("cid")
    if not user or not cid:
        return jsonify({"error":"user and cid required"}), 400

    did = "did:vericrypt:" + hashlib.sha256((user+str(uuid.uuid4())).encode()).hexdigest()
    credential = {
        "did": did,
        "user": user,
        "cid": cid
    }
    # encrypt credential
    encrypted = FERNET.encrypt(json.dumps(credential).encode())
    # sign
    signature = sign_data(json.dumps(credential).encode())
    # store
    credential_vault[did] = {"encrypted": encrypted, "signature": signature}
    return jsonify({
        "message":"issued",
        "did": did,
        "signature_hex": signature.hex(),
        "pubkey_fingerprint": PUBKEY_FINGERPRINT
    })

@app.route("/verify/<did>", methods=["GET"])
def verify(did):
    cred = credential_vault.get(did)
    if not cred:
        return jsonify({"error":"not_found"}), 404
    decrypted = json.loads(FERNET.decrypt(cred["encrypted"]).decode())
    sig_valid = verify_signature(json.dumps(decrypted).encode(), cred["signature"])
    return jsonify({
        "credential": decrypted,
        "signature_valid": sig_valid,
        "pubkey_fingerprint": PUBKEY_FINGERPRINT
    })

if _name=="main_":
    app.run(port=5000)
backend